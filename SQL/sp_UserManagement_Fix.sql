-- ???????????????????????????????????????????????????????????????????????????????
-- FIX sp_CreateUser STORED PROCEDURE
-- ???????????????????????????????????????????????????????????????????????????????
-- Database: sandhyaflames
-- Purpose: Ensure sp_CreateUser returns success/message format for C# compatibility
-- Issue: ExecuteNonQueryAsync returns -1 when SP has SELECT, breaking boolean checks
-- Solution: SP must return SELECT with success column
-- ???????????????????????????????????????????????????????????????????????????????

USE sandhyaflames;
GO

-- ???????????????????????????????????????????????????????????????????????????????
-- sp_CreateUser - Create new user
-- ???????????????????????????????????????????????????????????????????????????????

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sp_CreateUser]') AND type = 'P')
    DROP PROCEDURE [dbo].[sp_CreateUser];
GO

CREATE PROCEDURE [dbo].[sp_CreateUser]
 @FullName NVARCHAR(100),
    @Email NVARCHAR(100),
    @PasswordHash NVARCHAR(255),  -- Already hashed by backend
    @RoleId INT
AS
BEGIN
    SET NOCOUNT ON;

    -- Check if email already exists
    IF EXISTS (SELECT 1 FROM Users WHERE Email = @Email)
    BEGIN
        SELECT 0 AS success, 'Email already exists' AS message;
        RETURN;
    END
    
    -- Password is already hashed by backend, DO NOT hash again
    -- Backend uses: PasswordHelper.ComputeSha256Hash(user.Password)
    INSERT INTO Users (FullName, Email, PasswordHash, RoleId, IsActive)
    VALUES (@FullName, @Email, @PasswordHash, @RoleId, 1);
    
    DECLARE @UserId INT = SCOPE_IDENTITY();
    
    SELECT 1 AS success, @UserId AS userId, 'User created successfully' AS message;
END
GO

PRINT '? sp_CreateUser - Returns SELECT with success column';
GO

-- ???????????????????????????????????????????????????????????????????????????????
-- VERIFICATION
-- ???????????????????????????????????????????????????????????????????????????????

PRINT '';
PRINT '??????????????????????????????????????????????????????????????????';
PRINT 'VERIFICATION: Testing sp_CreateUser';
PRINT '??????????????????????????????????????????????????????????????????';

-- Test 1: Create User (Success)
PRINT '';
PRINT '1?? Testing sp_CreateUser (Success):';
PRINT '----------------------------------------';
EXEC sp_CreateUser 
    @FullName = 'Test User',
    @Email = 'test@example.com',
    @PasswordHash = 'EA71C25A7A602246B4C39824B855678894A96F43BB9B71319C39700A1E045222',
    @RoleId = 2;
-- Expected: success = 1, userId = X, message = "User created successfully"

-- Test 2: Create User (Email Exists)
PRINT '';
PRINT '2?? Testing sp_CreateUser (Duplicate Email):';
PRINT '----------------------------------------';
EXEC sp_CreateUser 
    @FullName = 'Another User',
    @Email = 'test@example.com',
    @PasswordHash = 'EA71C25A7A602246B4C39824B855678894A96F43BB9B71319C39700A1E045222',
    @RoleId = 2;
-- Expected: success = 0, message = "Email already exists"

-- Clean up test data
PRINT '';
PRINT '?? Cleaning up test data...';
DELETE FROM Users WHERE Email = 'test@example.com';
PRINT '? Test data removed';

PRINT '';
PRINT '??????????????????????????????????????????????????????????????????';
PRINT '? sp_CreateUser UPDATED SUCCESSFULLY';
PRINT '??????????????????????????????????????????????????????????????????';
PRINT '';
PRINT 'SP now returns SELECT with success column:';
PRINT '  • sp_CreateUser ? SELECT success, userId, message';
PRINT '';
PRINT 'C# Code Pattern (ALREADY IMPLEMENTED):';
PRINT '  using var reader = await cmd.ExecuteReaderAsync();';
PRINT '  if (await reader.ReadAsync())';
PRINT '  {';
PRINT ' var success = reader.GetInt32(reader.GetOrdinal("success"));';
PRINT '      return success == 1;';
PRINT '  }';
PRINT '  return false;';
PRINT '';
PRINT 'Next Steps:';
PRINT '1. Test in Swagger: POST /api/users';
PRINT '2. Test from Angular frontend';
PRINT '3. After successful testing, check sp_UpdateUser and sp_SoftDeleteUser';
PRINT '';
GO
