-- ???????????????????????????????????????????????????????????????????????????????
-- STORED PROCEDURES FOR USER AND ROLE LIST ENDPOINTS
-- ???????????????????????????????????????????????????????????????????????????????
-- Database: sandhyaflames
-- Purpose: Support /api/users/list and /api/roles/list endpoints
-- Created: 2025-01-26
-- ???????????????????????????????????????????????????????????????????????????????

USE sandhyaflames;
GO

-- ???????????????????????????????????????????????????????????????????????????????
-- 1?? sp_ListUsers - List all users with role information
-- ???????????????????????????????????????????????????????????????????????????????

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sp_ListUsers]') AND type = 'P')
  DROP PROCEDURE [dbo].[sp_ListUsers];
GO

CREATE PROCEDURE [dbo].[sp_ListUsers]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        u.UserId AS userId,
        u.FullName AS fullName,
        u.Email AS email,
        u.RoleId AS roleId,
  r.RoleName AS roleName,
u.IsActive AS isActive
    FROM Users u
    INNER JOIN Roles r ON u.RoleId = r.RoleId
    ORDER BY u.FullName;
END
GO

-- ???????????????????????????????????????????????????????????????????????????????
-- 2?? sp_ListRoles - List all roles with user count
-- ???????????????????????????????????????????????????????????????????????????????

IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[sp_ListRoles]') AND type = 'P')
    DROP PROCEDURE [dbo].[sp_ListRoles];
GO

CREATE PROCEDURE [dbo].[sp_ListRoles]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        r.RoleId AS roleId,
        r.RoleName AS roleName,
        r.Description AS description,
        r.IsActive AS isActive,
        COUNT(u.UserId) AS userCount
    FROM Roles r
    LEFT JOIN Users u ON r.RoleId = u.RoleId AND u.IsActive = 1
    GROUP BY r.RoleId, r.RoleName, r.Description, r.IsActive
    ORDER BY r.RoleName;
END
GO

-- ???????????????????????????????????????????????????????????????????????????????
-- VERIFICATION QUERIES
-- ???????????????????????????????????????????????????????????????????????????????

PRINT '??????????????????????????????????????????????????????????????????';
PRINT 'VERIFICATION: Testing Stored Procedures';
PRINT '??????????????????????????????????????????????????????????????????';

-- Test sp_ListUsers
PRINT '';
PRINT '1?? Testing sp_ListUsers:';
PRINT '----------------------------------------';
EXEC sp_ListUsers;

-- Test sp_ListRoles
PRINT '';
PRINT '2?? Testing sp_ListRoles:';
PRINT '----------------------------------------';
EXEC sp_ListRoles;

PRINT '';
PRINT '??????????????????????????????????????????????????????????????????';
PRINT '? STORED PROCEDURES CREATED SUCCESSFULLY';
PRINT '??????????????????????????????????????????????????????????????????';
PRINT '';
PRINT 'Next Steps:';
PRINT '1. Verify data is returned above';
PRINT '2. Test in Swagger: GET /api/users/list';
PRINT '3. Test in Swagger: GET /api/roles/list';
PRINT '4. Test from Angular frontend';
PRINT '';
GO

-- ???????????????????????????????????????????????????????????????????????????????
-- SAMPLE DATA (OPTIONAL - Run only if tables are empty)
-- ???????????????????????????????????????????????????????????????????????????????

/*
-- Uncomment this section if you need sample data

-- Insert sample roles
IF NOT EXISTS (SELECT 1 FROM Roles WHERE RoleId = 1)
BEGIN
    SET IDENTITY_INSERT Roles ON;
    
    INSERT INTO Roles (RoleId, RoleName, Description, IsActive)
    VALUES 
        (1, 'Administrator', 'Full system access', 1),
        (2, 'Operator', 'Limited access to operations', 1),
        (3, 'Viewer', 'Read-only access', 1);
    
  SET IDENTITY_INSERT Roles OFF;
    
    PRINT '? Sample roles inserted';
END

-- Insert sample users (with hashed password 'password123')
IF NOT EXISTS (SELECT 1 FROM Users WHERE UserId = 1)
BEGIN
    SET IDENTITY_INSERT Users ON;
 
    INSERT INTO Users (UserId, FullName, Email, Password, RoleId, IsActive)
    VALUES 
   (1, 'Admin User', 'admin@example.com', HASHBYTES('SHA2_256', 'password123'), 1, 1),
        (2, 'John Doe', 'john@example.com', HASHBYTES('SHA2_256', 'password123'), 2, 1),
        (3, 'Jane Smith', 'jane@example.com', HASHBYTES('SHA2_256', 'password123'), 2, 1),
      (4, 'Bob Wilson', 'bob@example.com', HASHBYTES('SHA2_256', 'password123'), 3, 1);
    
    SET IDENTITY_INSERT Users OFF;
    
    PRINT '? Sample users inserted';
END
*/
